/*
 * jQuery throttle / debounce - v1.1 - 3/7/2010
 * http://benalman.com/projects/jquery-throttle-debounce-plugin/
 * 
 * Copyright (c) 2010 "Cowboy" Ben Alman
 * Dual licensed under the MIT and GPL licenses.
 * http://benalman.com/about/license/
 */
 
 /*
 * ScaleRaphael 0.8 by Zevan Rosser 2010 
 * For use with Raphael library : www.raphaeljs.com
 * Licensed under the MIT license.
 *
 * www.shapevent.com/scaleraphael/
 */

 /*
 * OLsubwaymap
 * Licensed under the MIT License (MIT). (http://opensource.org/licenses/MIT)
 * Copyright Â© 2013 openlectures LLP (http://openlectures.org/).
 * 
 * https://github.com/openlectures/OLsubway.js
 */
(function(e,t){var n=e.jQuery||e.Cowboy||(e.Cowboy={}),r;n.throttle=r=function(e,r,i,s){function a(){function p(){u=+(new Date);i.apply(n,l)}function v(){o=t}var n=this,a=+(new Date)-u,l=arguments;if(s&&!o){p()}o&&clearTimeout(o);if(s===t&&a>e){p()}else{if(r!==true){o=setTimeout(s?v:p,s===t?e-a:e)}}}var o,u=0;if(typeof r!=="boolean"){s=i;i=r;r=t}if(n.guid){a.guid=i.guid=i.guid||n.guid++}return a};n.debounce=function(e,n,i){return i===t?r(e,n,false):r(e,i,n!==false)}})(this);(function(){window.ScaleRaphael=function(e,t,n){var r=document.getElementById(e);if(!r.style.position)r.style.position="relative";r.style.width=t+"px";r.style.height=n+"px";r.style.overflow="hidden";var i;if(Raphael.type=="VML"){r.innerHTML="<rvml:group style='position : absolute; width: 1000px; height: 1000px; top: 0px; left: 0px' coordsize='1000,1000' class='rvml' id='vmlgroup'></rvml:group>";i=document.getElementById("vmlgroup")}else{r.innerHTML="<div id='svggroup'></div>";i=document.getElementById("svggroup")}var s=new Raphael(i,t,n);var o;if(Raphael.type=="SVG"){s.canvas.setAttribute("viewBox","0 0 "+t+" "+n)}else{o=r.getElementsByTagName("div")[0]}s.changeSize=function(e,u,a,f){f=!f;var l=e/t;var c=u/n;var h=l<c?l:c;var p=parseInt(n*h);var d=parseInt(t*h);if(Raphael.type=="VML"){var v=document.getElementsByTagName("textpath");for(var m in v){var g=v[m];if(g.style){if(!g._fontSize){var y=g.style.font.split("px");g._fontSize=parseInt(y[0]);g._font=y[1]}g.style.font=g._fontSize*h+"px"+g._font}}var b;if(d<p){b=d*1e3/t}else{b=p*1e3/n}b=parseInt(b);i.style.width=b+"px";i.style.height=b+"px";if(f){i.style.left=parseInt((e-d)/2)+"px";i.style.top=parseInt((u-p)/2)+"px"}o.style.overflow="visible"}if(f){d=e;p=u}r.style.width=d+"px";r.style.height=p+"px";s.setSize(d,p);if(a){r.style.position="absolute";r.style.left=parseInt((e-d)/2)+"px";r.style.top=parseInt((u-p)/2)+"px"}};s.scaleAll=function(e){s.changeSize(t*e,n*e)};s.changeSize(t,n);s.w=t;s.h=n;return s}})();(function(e){function g(e,t){this.x=e;this.y=t}function y(e,t,n,r){this.name=e;this.color=t;this.fontSize=n;this.fontColor=r;this.edges=new Array}function b(e,t){g.call(this,e.x,e.y);this.pt=t}function w(e,t){this.color=e;this.segments=new Array(S(t))}function E(e,t,n,r,i,s){this.name=t;this.href=n;this.labelDir=r;this.labelTer=i;this.terminals=new Array;this.links=s;this.ID=e;this.elements=[new Array,new Array,new Array]}function S(e){return new g(e.x*t,e.y*t)}function x(e,n){var r=e.x,i=e.y;var s=0;if(e.x-n.x>0)r-=f*t;else if(e.x-n.x<0){r+=f*t;s=180}if(e.y-n.y>0){i-=f*t;s=90}else if(e.y-n.y<0){i+=f*t;s=270}return[new g(r,i),s]}function T(e,t){var n=t.set();for(var r in e)n.push(e[r]);return n}var t=20;var n=.45;var r=.4;var s=.55;var o=.1;var u=14;var a="#bbb";var f=.7;var l=40;var c="M0,0 l0,0.5 0.6,-0.5 -0.6,-0.5z";var h=["#000","#eee"];var p=["#03f","#709"];var d=2*r*s;var v=r-o;var m=d-o*2.4;if(typeof Object.create=="undefined"){Object.create=function(e){function t(){}t.prototype=e;return new t}}g.prototype.toString=function(){return this.x+","+this.y};y.prototype.addEdge=function(e){e=S(e);this.edges.push(e)};y.prototype.centroid=function(){try{if(this.edges.length<1)throw new Error("Polygon has no points!")}catch(e){console.error(e.name+": "+e.message)}this.edges.push(this.edges[0]);var t=0,n=0,r=0;for(var i=0;i<this.edges.length-1;i++){t+=(this.edges[i].x+this.edges[i+1].x)*(this.edges[i].x*this.edges[i+1].y-this.edges[i+1].x*this.edges[i].y);n+=(this.edges[i].y+this.edges[i+1].y)*(this.edges[i].x*this.edges[i+1].y-this.edges[i+1].x*this.edges[i].y);r+=this.edges[i].x*this.edges[i+1].y-this.edges[i+1].x*this.edges[i].y}this.edges.pop();return new g(1/(3*r)*t,1/(3*r)*n)};y.prototype.paint=function(e){if(this.edges.length>2){var t="M";for(i in this.edges){t+=this.edges[i].toString()+" "}this.background=e.path(t+"z").attr({fill:this.color,stroke:"none"});var n=this.centroid();e.text(n.x,n.y,this.name).attr({"font-size":this.fontSize,fill:this.fontColor})}};b.prototype=Object.create(g.prototype);b.prototype.toString=function(){return this.pt+" "+g.prototype.toString.call(this)};w.prototype.addSegment=function(e,t){e=S(e);if(typeof t=="undefined")this.segments.push(e);else if(t.toUpperCase()=="N"||t.toUpperCase()=="S")this.segments.push(new b(e,new g(e.x,this.segments[this.segments.length-1].y)));else if(t=="E"||t=="W")this.segments.push(new b(e,new g(this.segments[this.segments.length-1].x,e.y)))};w.prototype.paint=function(e){this.arrowHead(e);var r="M"+this.segments[0]+" ";for(var i=1;i<this.segments.length;i++){if(this.segments[i]instanceof b)r+="Q"+this.segments[i]+" ";else r+="L"+this.segments[i]+" "}e.path(r).attr({stroke:this.color,"stroke-width":n*t})};w.prototype.arrowHead=function(e){if(this.segments.length>1){var n=this.segments.pop();var r;if(n instanceof b){r=x(n,n.pt);n=new b(r[0],n.pt)}else{r=x(n,this.segments[this.segments.length-1]);n=new g(r[0].x,r[0].y)}this.segments.push(n);e.path(c).attr({fill:this.color,stroke:"none"}).transform("T"+n.x+","+n.y+"S"+t+"R"+r[1])}};E.prototype.addTerminal=function(e){this.terminals.push(S(e))};E.prototype.linkGlow=function(){this.elements[2].show()};E.prototype.linkUnGlow=function(){this.elements[2].hide()};E.prototype.paint=function(e){var n=0;for(s in this.terminals){var i;i=e.circle(this.terminals[s].x,this.terminals[s].y,r*t).attr("fill",h[0]);this.elements[0].push(i);this.elements[1].push(i.glow({width:t/2,color:p[0]}));this.elements[2].push(i.glow({width:t/2,color:p[1]}));if(n!==0){i=e.path("M"+n+" L"+this.terminals[s]).attr({stroke:h[0],"stroke-width":t*d});this.elements[0].push(i);this.elements[1].push(i.glow({width:t*d/2*1.8,opacity:.8,color:p[0]}));this.elements[2].push(i.glow({width:t*d/2*1.8,opacity:.8,color:p[1]}))}n=this.terminals[s]}n=0;for(s in this.terminals){i=e.circle(this.terminals[s].x,this.terminals[s].y,t*v).attr("fill",h[1]);this.elements[0].push(i);if(n!==0){i=e.path("M"+n+" L"+this.terminals[s]).attr({stroke:h[1],"stroke-width":t*m});this.elements[0].push(i)}n=this.terminals[s]}for(var s in this.terminals){this.elements[0].push(e.text(this.terminals[s].x,this.terminals[s].y,this.ID+1).attr({"font-size":v*t*1.8,"font-weight":"bolder"}))}var o=this.printLabel(e);this.elements[0].push(o);for(s in this.elements)this.elements[s]=T(this.elements[s],e);this.elements[1].hide();this.elements[2].hide();var u=this.elements[1];var a=this.links;this.elements[0].mouseover(function(e){u.show();o.attr("font-weight","bolder");for(var t in a){if(typeof a[t]!="undefined")a[t].linkGlow()}}).mouseout(function(e){u.hide();o.attr("font-weight","normal");for(var t in a){if(typeof a[t]!="undefined")a[t].linkUnGlow()}});this.elements[0].attr("href",this.href)};E.prototype.printLabel=function(e){if(typeof this.labelTer=="undefined")this.labelTer=1;if(typeof this.labelDir=="undefined")this.labelDir="S";try{if(this.labelTer<0||this.terminals.length<this.labelTer)throw new Error("Invalid terminal number!")}catch(n){console.error(n.name+": "+n.message)}var r=this.terminals[this.labelTer-1].x,i=this.terminals[this.labelTer-1].y;var s="middle";switch(this.labelDir.toUpperCase()){case"N":i-=t;break;case"NW":case"WN":r-=t/2;i-=t/2;s="end";break;case"W":r-=t/2;s="end";break;case"SW":case"WS":r-=t/2;i+=t/2;s="end";break;case"S":i+=t;break;case"SE":case"ES":r+=t/2;i+=t/2;s="start";break;case"E":r+=t/2;s="start";break;case"NE":case"EN":r+=t/2;i-=t/2;s="start";break}var o=e.text(r,i,this.name).attr({"text-anchor":s,"font-size":u});return o};e.OLSubway=function(){this.paintQueue=new Array;this.stations=new Array;this.islands=new Array;this.boundBox=new g(0,0);this.display="subway";this.data=undefined};e.OLSubway.prototype.reOrderStations=function(){for(var e=2;e>=0;e--){for(var t in this.stations)this.stations[t].elements[e].toFront()}};e.OLSubway.prototype.maxCoord=function(e){this.boundBox.x=Math.max(this.boundBox.x,Math.floor(e.x));this.boundBox.y=Math.max(this.boundBox.y,Math.floor(e.y))};e.OLSubway.prototype.canvasResize=function(){var e=$("#"+this.display).parent();this.paper.changeSize(e.width(),e.width(),false,true)};e.OLSubway.prototype.create=function(e,n){if(typeof e!="undefined")this.display=e;if(typeof n=="undefined")this.data=e;else this.data=n;this.data="#"+this.data;var r=$(this.data);var i=this;$(".subway-islands",r).each(function(e,t){var n=new y($(t).data("island-name"),$(t).data("background-color"),$(t).data("font-size"),$(t).data("font-color"));$(t).children().each(function(e,t){var r=$(t).data("edge").split(",");var s=new g(parseFloat(r[0]),parseFloat(r[1]));n.addEdge(s);i.maxCoord(s)});i.islands.push(n);i.paintQueue.push(n)});$(".subway-tracks",r).each(function(e,t){var n=$(t).data("start-point").split(",");var r=new g(parseInt(n[0]),parseInt(n[1]));var s=new w($(t).data("color"),r);i.maxCoord(r);$(t).children().each(function(e,t){var n=$(t).data("dest").split(",");r=new g(parseInt(n[0]),parseInt(n[1]));s.addSegment(r,$(t).data("turn"));i.maxCoord(r)});i.paintQueue.push(s)});$("#subway-stations",r).children().each(function(e,t){var n=$(t).text().replace(/\\n/g,"\n");var r=$(t).children("a").first().attr("href");var s=$(t).data("label-dir");var o=$(t).data("label-ter");var u=$(t).data("link");if(typeof u!="undefined"){u=u.toString().split(",");for(var a in u)u[a]=parseInt(u[a]-1)}var f=new E(i.stations.length,n,r,s,o,u);var l=$(t).data("pos").split(/[,;]/);for(a=1;a<=l.length;a+=2){var c=new g(parseInt(l[a-1]),parseInt(l[a]));f.addTerminal(c);i.maxCoord(c)}i.stations.push(f);i.paintQueue.push(f)});for(var s in this.stations){var o=this.stations[s];for(var u in o.links){if(s==u)o.links[u]=undefined;else o.links[u]=this.stations[o.links[u]]}}var f=this.boundBox.x+1,c=this.boundBox.y+1;this.paper=ScaleRaphael(this.display,f*t,c*t);for(s in this.paintQueue){this.paintQueue[s].paint(this.paper)}this.reOrderStations();if($(this.data).data("debug")){for(s=0;s<=f;s++){this.paper.path("M"+s*t+", 0 L"+s*t+", "+c*t).attr({stroke:a,"stroke-width":2}).toBack()}for(s=0;s<=c;s++){this.paper.path("M0, "+s*t+" L"+f*t+", "+s*t).attr({stroke:a,"stroke-width":2}).toBack()}for(s in this.islands)this.islands[s].background.toBack()}this.canvasResize();window.onresize=$.debounce(l,function(){i.canvasResize()});if("#"+this.display!=this.data)$(this.data).hide()};e.OLSubway.prototype.destroy=function(){this.paper.remove();this.paintQueue=new Array;this.stations=new Array;this.islands=new Array;this.boundBox=new g(0,0);this.display="subway";this.data=undefined}})(this)